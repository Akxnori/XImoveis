-- XImóveis Database Schema (MySQL 8)
-- Ensure you run as a user with privileges to create database and tables

DROP DATABASE IF EXISTS ximoveis;
CREATE DATABASE ximoveis CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE ximoveis;

-- Agencies
CREATE TABLE agencies (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Users
CREATE TABLE users (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  agency_id BIGINT UNSIGNED NULL,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  role ENUM('ADMIN','BROKER','AGENCY') NOT NULL DEFAULT 'BROKER',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_users_agency FOREIGN KEY (agency_id) REFERENCES agencies(id) ON DELETE SET NULL
);

-- Properties
CREATE TABLE properties (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  agency_id BIGINT UNSIGNED NULL,
  user_id BIGINT UNSIGNED NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT NULL,
  price DECIMAL(15,2) NULL,
  bedrooms INT DEFAULT 0,
  bathrooms INT DEFAULT 0,
  suites INT DEFAULT 0,
  parking_spaces INT DEFAULT 0,
  area_m2 DECIMAL(10,2) NULL,
  lot_size_m2 DECIMAL(10,2) NULL,
  year_built INT NULL,
  floor INT NULL,
  maintenance_fee DECIMAL(10,2) NULL,
  iptu DECIMAL(10,2) NULL,
  address VARCHAR(255) NULL,
  neighborhood VARCHAR(120) NULL,
  city VARCHAR(120) NOT NULL,
  state VARCHAR(2) NOT NULL,
  purpose ENUM('SALE','RENT') NOT NULL,
  type VARCHAR(50) NOT NULL,
  status ENUM('DRAFT','PENDING','ACTIVE','REJECTED','SOLD') NOT NULL DEFAULT 'DRAFT',
  certificate_required BOOLEAN NOT NULL DEFAULT TRUE,
  certificate_verified BOOLEAN NOT NULL DEFAULT FALSE,
  location POINT SRID 4326 NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_properties_status (status),
  INDEX idx_properties_city_state (city, state),
  INDEX idx_properties_price (price),
  SPATIAL INDEX spx_properties_location (location),
  CONSTRAINT fk_properties_agency FOREIGN KEY (agency_id) REFERENCES agencies(id) ON DELETE SET NULL,
  CONSTRAINT fk_properties_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- Property images (placeholder for future uploads)
CREATE TABLE property_images (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  property_id BIGINT UNSIGNED NOT NULL,
  image_path VARCHAR(500) NOT NULL,
  is_cover BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_property_images_property (property_id),
  CONSTRAINT fk_prop_images_property FOREIGN KEY (property_id) REFERENCES properties(id) ON DELETE CASCADE
);

-- Property history
CREATE TABLE property_history (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  property_id BIGINT UNSIGNED NOT NULL,
  event_date DATETIME NOT NULL,
  event_type ENUM('CREATED','PRICE_CHANGE','STATUS_CHANGE','NOTE') NOT NULL,
  price DECIMAL(15,2) NULL,
  source VARCHAR(255) NULL,
  notes TEXT NULL,
  INDEX idx_prop_hist_property (property_id),
  INDEX idx_prop_hist_date (event_date),
  CONSTRAINT fk_prop_hist_property FOREIGN KEY (property_id) REFERENCES properties(id) ON DELETE CASCADE
);

-- Property certificates
CREATE TABLE property_certificates (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  property_id BIGINT UNSIGNED NOT NULL,
  filename VARCHAR(255) NOT NULL,
  path VARCHAR(500) NOT NULL,
  mimetype VARCHAR(100) NOT NULL,
  size BIGINT NOT NULL,
  sha256_hash CHAR(64) NOT NULL,
  verification_status ENUM('PENDING','APPROVED','REJECTED') NOT NULL DEFAULT 'PENDING',
  verified_by BIGINT UNSIGNED NULL,
  verified_at DATETIME NULL,
  notes TEXT NULL,
  uploaded_at DATETIME NOT NULL,
  INDEX idx_prop_cert_property (property_id),
  INDEX idx_prop_cert_verif_status (verification_status),
  CONSTRAINT fk_prop_cert_property FOREIGN KEY (property_id) REFERENCES properties(id) ON DELETE CASCADE,
  CONSTRAINT fk_prop_cert_verified_by FOREIGN KEY (verified_by) REFERENCES users(id) ON DELETE SET NULL
);

-- Seed: one agency
INSERT INTO agencies (name, email) VALUES ('Agência X', 'contato@agenciax.local');

-- Sample ACTIVE properties (for demo)
-- Brasília
INSERT INTO properties (
  agency_id, user_id, title, description, price, bedrooms, bathrooms, city, state,
  purpose, type, status, certificate_required, certificate_verified, location
) VALUES (
  NULL, NULL, 'Casa aconchegante no Lago Sul', 'Ótima casa próxima ao lago.', 1250000.00, 4, 3, 'Brasília', 'DF',
  'SALE', 'HOUSE', 'ACTIVE', TRUE, TRUE, ST_GeomFromText('POINT(-47.861  -15.843)', 4326)
);

-- São Paulo
INSERT INTO properties (
  agency_id, user_id, title, description, price, bedrooms, bathrooms, city, state,
  purpose, type, status, certificate_required, certificate_verified, location
) VALUES (
  NULL, NULL, 'Apartamento na Vila Mariana', 'Apartamento com varanda e vista.', 780000.00, 2, 2, 'São Paulo', 'SP',
  'SALE', 'APARTMENT', 'ACTIVE', TRUE, TRUE, ST_GeomFromText('POINT(-46.635 -23.588)', 4326)
);

-- Rio de Janeiro
INSERT INTO properties (
  agency_id, user_id, title, description, price, bedrooms, bathrooms, city, state,
  purpose, type, status, certificate_required, certificate_verified, location
) VALUES (
  NULL, NULL, 'Kitnet em Copacabana', 'Ideal para temporada.', 2500.00, 1, 1, 'Rio de Janeiro', 'RJ',
  'RENT', 'APARTMENT', 'ACTIVE', TRUE, TRUE, ST_GeomFromText('POINT(-43.183 -22.971)', 4326)
);

-- History for samples
INSERT INTO property_history (property_id, event_date, event_type, price, source, notes)
SELECT id, NOW(), 'CREATED', price, 'seed', 'Imóvel criado (seed)'
FROM properties WHERE city IN ('Brasília', 'São Paulo', 'Rio de Janeiro');

INSERT INTO property_history (property_id, event_date, event_type, price, source, notes)
SELECT id, NOW(), 'STATUS_CHANGE', NULL, 'seed', 'Aprovado para ACTIVE'
FROM properties WHERE city IN ('Brasília', 'São Paulo', 'Rio de Janeiro');

-- Certificates metadata for samples (dummy placeholders)
INSERT INTO property_certificates (
  property_id, filename, path, mimetype, size, sha256_hash, verification_status, verified_by, verified_at, notes, uploaded_at
)
SELECT id, 'dummy.pdf', 'uploads/dummy.pdf', 'application/pdf', 1234,
       '0000000000000000000000000000000000000000000000000000000000000000',
       'APPROVED', NULL, NOW(), 'Seed aprovado', NOW()
FROM properties WHERE city IN ('Brasília', 'São Paulo', 'Rio de Janeiro');

