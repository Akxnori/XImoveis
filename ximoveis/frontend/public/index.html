<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XImóveis — Início</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="js/auth-ui.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
</head>
<body>
  <header>
    <a class="logo" href="index.html"><img src="assets/logo.png" alt="XImóveis" style="height:32px"/></a>
    <nav>
      <a href="index.html">Início</a>
      <a href="busca.html">Buscar</a>
      <a href="mapa.html">Mapa</a>
      <a href="cadastrar.html" class="nav-auth nav-agent">Cadastrar</a>
      <a href="meus-imoveis.html" class="nav-auth nav-agent">Meus Imóveis</a>
      <a href="admin-dashboard.html" class="nav-auth nav-admin">Admin</a>
      <a href="login.html" id="authLink" class="nav-guest">Entrar</a>
    </nav>
  </header>

  <section class="hero-landing">
    <div class="title">Encontre seu lar</div>
    <div class="search-wrap">
      <div class="pill-tabs">
        <button type="button" id="tabAlugar" class="active">Alugar</button>
        <button type="button" id="tabComprar">Comprar</button>
      </div>
      <div class="searchbox">
        <select id="heroType">
          <option value="">Tipo de imóvel</option>
          <option value="APARTMENT">Apartamento</option>
          <option value="HOUSE">Casa</option>
          <option value="LAND">Terreno</option>
        </select>
        <input id="heroQuery" type="text" placeholder="Digite cidades, bairros ou características (ex: piscina)" style="flex:1" />
        <button id="heroBuscar" class="cta">Buscar</button>
      </div>
    </div>
  </section>

  <div class="container">
    <section class="content">
      <h2 class="mb-2">Imóveis em destaque</h2>
      <div class="carousel">
        <div id="featured" class="carousel-track"></div>
      </div>
    </section>

    <section class="content mt-3">
      <h2 class="mb-2">Mapa</h2>
      <p>Veja imóveis ativos no mapa interativo.</p>
      <div id="homeMap" style="height:380px; border-radius:8px; border:1px solid var(--border);"></div>
      <div class="mt-2"><a class="btn" href="mapa.html">Abrir mapa completo</a></div>
    </section>
  </div>

  <footer>© XImóveis. Todos os direitos reservados.</footer>

  <script>
    const API = 'http://localhost:3000';
    // Tabs hero
    let heroPurpose = 'RENT';
    const tabAlugar = document.getElementById('tabAlugar');
    const tabComprar = document.getElementById('tabComprar');
    tabAlugar.addEventListener('click', () => { heroPurpose='RENT'; tabAlugar.classList.add('active'); tabComprar.classList.remove('active'); });
    tabComprar.addEventListener('click', () => { heroPurpose='SALE'; tabComprar.classList.add('active'); tabAlugar.classList.remove('active'); });
    document.getElementById('heroBuscar').addEventListener('click', () => {
      const type = document.getElementById('heroType').value;
      const q = encodeURIComponent(document.getElementById('heroQuery').value || '');
      const usp = new URLSearchParams(); if (type) usp.set('type', type); if (heroPurpose) usp.set('purpose', heroPurpose); if (q) usp.set('q', q);
      location.href = `busca.html?${usp.toString()}`;
    });

    // Dataset local (fallback) e imagens
    let IMG_MAP = {}; async function loadImageMap(){ try { const r = await fetch('assets/property-images.json'); if (r.ok) IMG_MAP = await r.json(); } catch{} }
    function firstImageFor(id){ const arr = IMG_MAP[id]; return arr && arr.length ? arr[0] : `https://picsum.photos/seed/${id}/400/300`; }
    function labelType(t){ switch(String(t||'').toUpperCase()){ case 'HOUSE': return 'Casa'; case 'APARTMENT': return 'Apartamento'; case 'LAND': return 'Terreno'; default: return t||''; } }
    function labelPurpose(x){ switch(String(x||'').toUpperCase()){ case 'SALE': return 'Venda'; case 'RENT': return 'Aluguel'; default: return x||''; } }

    function cardHtml(p){
      const price = p.price!=null ? Number(p.price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '';
      const badge = p.certificate_verified ? ' ✓ Certidão verificada' : '';
      return `
        <div class="card">
          <img src="${firstImageFor(p.id)}" alt="Imagem do imóvel"/>
          <div class="body">
            <div class="title">${p.title||'Imóvel'}</div>
            <div class="meta">${price} — ${p.city||''}/${p.state||''} &bull; ${labelType(p.type)} &bull; ${labelPurpose(p.purpose)}${badge}</div>
            <div class="actions">
              <a href="imovel.html?id=${p.id}">Ver detalhes</a>
              <a href="mapa.html#${p.lat},${p.lng}">Ver no mapa</a>
            </div>
          </div>
        </div>`;
    }

    async function loadFeatured(){
      let data = [];
      try { const res = await fetch(`${API}/properties?sort=priceDesc`); if (res.ok) data = await res.json(); } catch{}
      if (!data.length) { try { const r2 = await fetch('assets/demo-properties.json',{cache:'no-cache'}); if (r2.ok) data = await r2.json(); } catch{} }
      const featured = document.getElementById('featured');
      const items = data.slice(0,10);
      featured.innerHTML = items.map(cardHtml).join('');
      try { const track = featured; const cardWidth = 320; if (items.length > 1) setInterval(()=>{ const atEnd = track.scrollLeft + track.clientWidth >= track.scrollWidth - 5; if (atEnd) track.scrollTo({left:0,behavior:'smooth'}); else track.scrollBy({left:cardWidth,behavior:'smooth'}); }, 4000); } catch{}
    }

    async function initMap(){
      const map = L.map('homeMap').setView([-15.78,-47.93], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      const layer = L.layerGroup().addTo(map);
      async function loadInView(){
        const b = map.getBounds(); const bbox = [b.getWest(),b.getSouth(),b.getEast(),b.getNorth()].join(',');
        let items = [];
        try { const res = await fetch(`${API}/properties/map?bbox=${bbox}`); if (res.ok) items = await res.json(); } catch{}
        if (!items.length){ try { const r=await fetch('assets/demo-properties.json'); if (r.ok){ const all=await r.json(); const [w,s,e,n]=bbox.split(',').map(Number); items = all.filter(p=> p.lng>=w && p.lng<=e && p.lat>=s && p.lat<=n).map(p=>({ id:p.id,title:p.title,price:p.price,lat:p.lat,lng:p.lng })); } } catch{} }
        layer.clearLayers(); items.forEach(p=>{ const m=L.marker([p.lat,p.lng]); const price=p.price!=null?Number(p.price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}):''; m.bindPopup(`<b>${p.title||'Imóvel'}</b><br/>${price}`); layer.addLayer(m); });
      }
      map.on('moveend', loadInView); loadInView();
    }

    document.addEventListener('DOMContentLoaded', ()=>{ if (window.XAuthUI) XAuthUI.applyNav(); loadImageMap().then(loadFeatured); initMap(); });
  </script>
</body>
</html>



