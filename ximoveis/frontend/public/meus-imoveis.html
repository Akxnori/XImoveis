<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XImóveis — Meus Imóveis</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="js/auth-ui.js"></script>
</head>
<body>
  <header>
    <a class="logo" href="index.html"><img src="assets/logo.png" alt="XImóveis" style="height:28px"/></a>
    <nav>
      <a href="index.html">Início</a>
      <a href="mapa.html">Mapa</a>
      <a href="cadastrar.html" class="nav-auth nav-agent">Cadastrar</a>
      <a href="meus-imoveis.html" class="nav-auth nav-agent">Meus Imóveis</a>
      <a href="admin-dashboard.html" class="nav-auth nav-admin">Admin</a>
      <a href="login.html" id="authLink" class="nav-guest">Entrar</a>
    </nav>
  </header>
  <div class="container">
    <div class="card">
      <div class="space-between">
        <h2>Meus Imóveis</h2>
        <a class="btn" href="cadastrar.html">+ Novo</a>
      </div>
      <div id="alert" class="mt-2"></div>
      <table class="mt-2">
        <thead>
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Status</th>
            <th>Certidão</th>
            <th>Preço</th>
            <th>Cidade/UF</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
  <footer>
    © XImóveis. Todos os direitos reservados.
  </footer>

  <script>
    const API = 'http://localhost:3000';
    const token = localStorage.getItem('authToken');
    const user = localStorage.getItem('authUser') ? JSON.parse(localStorage.getItem('authUser')) : null;
    const alertBox = document.getElementById('alert');
    if (!token || !user) {
      alertBox.textContent = 'Você precisa estar logado como Corretor/Imobiliária para ver seus imóveis.';
    }

    function priceBRL(v){ return v!=null ? Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : ''; }
    function badgeStatus(s){
      const map = { PENDING: 'Pendente', ACTIVE: 'Ativo', REJECTED: 'Rejeitado', SOLD: 'Vendido', DRAFT: 'Rascunho' };
      return map[s] || s;
    }
    function badgeCert(c){
      if (!c) return '';
      const map = { PENDING: 'Aguardando', APPROVED: 'Aprovada', REJECTED: 'Rejeitada' };
      return map[c] || c;
    }

    async function load() {
      if (!token) return;
      try{
        const res = await fetch(`${API}/properties/mine/list`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error('Falha ao carregar');
        const items = await res.json();
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = items.map(p => {
          const view = p.status === 'ACTIVE' ? `<a class="btn" href="imovel.html?id=${p.id}">Ver</a>` : '';
          const cert = badgeCert(p.cert_status) + (p.cert_notes ? ` — ${p.cert_notes}` : '');
          return `<tr>
            <td>${p.id}</td>
            <td>${p.title || ''}</td>
            <td>${badgeStatus(p.status)}</td>
            <td>${cert}</td>
            <td>${priceBRL(p.price)}</td>
            <td>${p.city}/${p.state}</td>
            <td>${view}</td>
          </tr>`;
        }).join('');
      } catch(e){ alertBox.textContent = e.message || 'Erro ao carregar.'; }
    }

    load();
  </script>
</body>
</html>
